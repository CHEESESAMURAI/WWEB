#!/bin/bash

echo "ğŸ”§ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• 500 ĞĞ¨Ğ˜Ğ‘ĞĞš BACKEND..."

# Ğ¦Ğ²ĞµÑ‚Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

cd /opt/wild-analytics || { echo -e "${RED}Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°${NC}"; exit 1; }

log "ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ñ… Ğ»Ğ¾Ğ³Ğ¾Ğ² backend..."
docker logs wild-backend --tail 20

log "ğŸ›‘ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° backend Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ..."
docker stop wild-backend 2>/dev/null || true
docker rm wild-backend 2>/dev/null || true

log "ğŸ”§ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ main.py Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğ¼ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼..."
cat > web-dashboard/backend/main.py << 'EOF'
import os
import sys
import uvicorn
import traceback
from fastapi import FastAPI, HTTPException, Depends, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import Optional, List, Dict, Any
import sqlite3
import hashlib
import jwt
from datetime import datetime, timedelta
import logging
import json

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğ³Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

app = FastAPI(title="Wild Analytics API", version="2.0.0")

# CORS Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# JWT Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
SECRET_KEY = "wild-analytics-super-secret-key-2024-production"
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 1440

security = HTTPBearer()

# Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ‘Ğ”
DB_INITIALIZED = False

def init_database():
    """Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼"""
    global DB_INITIALIZED
    try:
        logger.info("ğŸ”§ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...")
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ğ¼ Ğ¿ÑƒÑ‚ÑŒ Ğº Ñ„Ğ°Ğ¹Ğ»Ñƒ Ğ‘Ğ”
        db_path = '/app/wild_analytics.db'
        logger.info(f"ğŸ“ ĞŸÑƒÑ‚ÑŒ Ğº Ğ‘Ğ”: {db_path}")
        
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        logger.info("âœ… ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ‘Ğ” ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾")
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                email TEXT UNIQUE NOT NULL,
                password_hash TEXT NOT NULL,
                name TEXT NOT NULL,
                balance REAL DEFAULT 15000.0,
                subscription_type TEXT DEFAULT 'Pro',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        logger.info("âœ… Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° users ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°/Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ°")
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS analyses (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                type TEXT NOT NULL,
                query TEXT,
                results TEXT,
                status TEXT DEFAULT 'completed',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users (id)
            )
        ''')
        logger.info("âœ… Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° analyses ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°/Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ°")
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        test_password = hashlib.sha256("password123".encode()).hexdigest()
        cursor.execute('SELECT id FROM users WHERE email = ?', ("test@example.com",))
        if not cursor.fetchone():
            cursor.execute('''
                INSERT INTO users (email, password_hash, name, balance, subscription_type)
                VALUES (?, ?, ?, ?, ?)
            ''', ("test@example.com", test_password, "Test User", 15000.0, "Pro"))
            logger.info("âœ… Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ğ½")
        else:
            logger.info("âœ… Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚")
        
        conn.commit()
        conn.close()
        DB_INITIALIZED = True
        logger.info("ğŸ¯ Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!")
        
        return True
        
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ‘Ğ”: {e}")
        logger.error(f"ğŸ“‹ Traceback: {traceback.format_exc()}")
        return False

# ĞœĞ¾Ğ´ĞµĞ»Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
class UserLogin(BaseModel):
    email: str
    password: str

class UserRegister(BaseModel):
    email: str
    password: str
    name: str

# Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
def hash_password(password: str) -> str:
    return hashlib.sha256(password.encode()).hexdigest()

def verify_password(plain_password: str, hashed_password: str) -> bool:
    return hash_password(plain_password) == hashed_password

def create_access_token(data: dict):
    try:
        to_encode = data.copy()
        expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
        to_encode.update({"exp": expire})
        encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
        return encoded_jwt
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ°: {e}")
        raise HTTPException(status_code=500, detail="Token creation failed")

def get_current_user(credentials: HTTPAuthorizationCredentials = Depends(security)):
    try:
        if not credentials:
            raise HTTPException(status_code=401, detail="Authorization required")
        
        token = credentials.credentials
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        user_id: int = payload.get("sub")
        
        if user_id is None:
            raise HTTPException(status_code=401, detail="Invalid token")
        
        conn = sqlite3.connect('/app/wild_analytics.db')
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))
        user = cursor.fetchone()
        conn.close()
        
        if user is None:
            raise HTTPException(status_code=401, detail="User not found")
            
        return {
            "id": user[0],
            "email": user[1],
            "name": user[3],
            "balance": user[4],
            "subscription_type": user[5]
        }
    except jwt.PyJWTError as e:
        logger.error(f"âŒ JWT Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}")
        raise HTTPException(status_code=401, detail="Invalid token")
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: {e}")
        raise HTTPException(status_code=500, detail="Authentication error")

# API Endpoints
@app.get("/")
async def root():
    return {
        "message": "Wild Analytics API v2.0 - Working!",
        "status": "running",
        "db_initialized": DB_INITIALIZED,
        "timestamp": datetime.now().isoformat()
    }

@app.get("/health")
async def health():
    return {
        "status": "healthy",
        "service": "wild-analytics-backend",
        "version": "2.0.0",
        "db_status": "initialized" if DB_INITIALIZED else "not_initialized",
        "timestamp": datetime.now().isoformat()
    }

@app.post("/auth/login")
async def login(user_data: UserLogin):
    try:
        logger.info(f"ğŸ” ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ° Ğ´Ğ»Ñ email: {user_data.email}")
        
        if not DB_INITIALIZED:
            logger.error("âŒ Ğ‘Ğ” Ğ½Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°!")
            raise HTTPException(status_code=500, detail="Database not initialized")
        
        conn = sqlite3.connect('/app/wild_analytics.db')
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM users WHERE email = ?", (user_data.email,))
        user = cursor.fetchone()
        conn.close()
        
        logger.info(f"ğŸ‘¤ ĞĞ°Ğ¹Ğ´ĞµĞ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: {user is not None}")
        
        if not user:
            logger.warning(f"âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_data.email} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")
            raise HTTPException(status_code=401, detail="Invalid credentials")
        
        password_valid = verify_password(user_data.password, user[2])
        logger.info(f"ğŸ”‘ ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚ĞµĞ½: {password_valid}")
        
        if not password_valid:
            logger.warning(f"âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ»Ñ {user_data.email}")
            raise HTTPException(status_code=401, detail="Invalid credentials")
        
        access_token = create_access_token(data={"sub": user[0]})
        
        result = {
            "success": True,
            "access_token": access_token,
            "user": {
                "id": user[0],
                "email": user[1],
                "name": user[3],
                "balance": user[4],
                "subscription_type": user[5]
            },
            "message": "Login successful"
        }
        
        logger.info(f"âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ Ğ²Ñ…Ğ¾Ğ´ Ğ´Ğ»Ñ {user_data.email}")
        return result
        
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°: {e}")
        logger.error(f"ğŸ“‹ Traceback: {traceback.format_exc()}")
        raise HTTPException(status_code=500, detail=f"Login failed: {str(e)}")

@app.post("/auth/register")
async def register(user_data: UserRegister):
    try:
        logger.info(f"ğŸ“ ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ email: {user_data.email}")
        
        if not DB_INITIALIZED:
            logger.error("âŒ Ğ‘Ğ” Ğ½Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°!")
            raise HTTPException(status_code=500, detail="Database not initialized")
        
        conn = sqlite3.connect('/app/wild_analytics.db')
        cursor = conn.cursor()
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        cursor.execute("SELECT id FROM users WHERE email = ?", (user_data.email,))
        existing_user = cursor.fetchone()
        
        if existing_user:
            conn.close()
            logger.warning(f"âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_data.email} ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚")
            raise HTTPException(status_code=400, detail="User already exists")
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        password_hash = hash_password(user_data.password)
        cursor.execute('''
            INSERT INTO users (email, password_hash, name, balance, subscription_type)
            VALUES (?, ?, ?, ?, ?)
        ''', (user_data.email, password_hash, user_data.name, 15000.0, "Pro"))
        
        user_id = cursor.lastrowid
        conn.commit()
        conn.close()
        
        access_token = create_access_token(data={"sub": user_id})
        
        result = {
            "success": True,
            "access_token": access_token,
            "user": {
                "id": user_id,
                "email": user_data.email,
                "name": user_data.name,
                "balance": 15000.0,
                "subscription_type": "Pro"
            },
            "message": "Registration successful"
        }
        
        logger.info(f"âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ğ°Ñ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ {user_data.email}")
        return result
        
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸: {e}")
        logger.error(f"ğŸ“‹ Traceback: {traceback.format_exc()}")
        raise HTTPException(status_code=500, detail=f"Registration failed: {str(e)}")

@app.get("/user/dashboard")
async def get_dashboard(current_user: dict = Depends(get_current_user)):
    try:
        logger.info(f"ğŸ“Š Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: {current_user['id']}")
        
        return {
            "user": current_user,
            "stats": {
                "products_analyzed": 156,
                "successful_analyses": 142,
                "monthly_usage": 45,
                "total_searches": 89,
                "recent_analyses": [
                    {"type": "Product Analysis", "date": "2024-07-27", "status": "success"},
                    {"type": "Brand Analysis", "date": "2024-07-26", "status": "success"},
                    {"type": "Category Analysis", "date": "2024-07-25", "status": "pending"}
                ]
            }
        }
        
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğ°: {e}")
        raise HTTPException(status_code=500, detail="Dashboard error")

# Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ
@app.on_event("startup")
async def startup_event():
    logger.info("ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Wild Analytics Backend...")
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ğ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹
    try:
        test_file = '/app/test_write.txt'
        with open(test_file, 'w') as f:
            f.write('test')
        os.remove(test_file)
        logger.info("âœ… Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸")
    except Exception as e:
        logger.error(f"âŒ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ¾Ğ¹: {e}")
    
    # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ‘Ğ”
    if init_database():
        logger.info("ğŸ¯ Backend ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½!")
    else:
        logger.error("ğŸ’¥ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸!")

if __name__ == "__main__":
    logger.info("ğŸ”¥ Ğ—Ğ°Ğ¿ÑƒÑĞº Wild Analytics Backend Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğ¼ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼...")
    uvicorn.run(app, host="0.0.0.0", port=8000, log_level="debug")
EOF

log "ğŸ”§ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ requirements.txt..."
cat > web-dashboard/backend/requirements.txt << 'EOF'
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic==2.5.0
python-multipart==0.0.6
PyJWT==2.8.0
python-jose[cryptography]==3.3.0
bcrypt==4.1.2
aiofiles==23.2.0
jinja2==3.1.2
requests==2.31.0
httpx==0.25.2
python-dotenv==1.0.0
EOF

log "ğŸ”§ ĞŸĞµÑ€ĞµÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Dockerfile..."
cat > web-dashboard/backend/Dockerfile << 'EOF'
FROM python:3.11-slim

WORKDIR /app

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
RUN apt-get update && apt-get install -y \
    curl \
    sqlite3 \
    && rm -rf /var/lib/apt/lists/*

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Python Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip
RUN pip install --no-cache-dir -r requirements.txt

# ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ´Ğ°
COPY . .

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹ Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ñ€Ğ°Ğ²
RUN mkdir -p /app/logs
RUN chmod 755 /app
RUN touch /app/wild_analytics.db
RUN chmod 666 /app/wild_analytics.db

EXPOSE 8000

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ¾ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ½Ğ¾ÑÑ‚Ğ¸
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8000/health || exit 1

CMD ["python", "main.py"]
EOF

log "ğŸ”¨ ĞŸĞµÑ€ĞµÑĞ±Ğ¾Ñ€ĞºĞ° backend Ñ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸ÑĞ¼Ğ¸..."
docker build -t wild-backend ./web-dashboard/backend

if [ $? -eq 0 ]; then
    log "âœ… Backend Ğ¿ĞµÑ€ĞµÑĞ¾Ğ±Ñ€Ğ°Ğ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!"
    
    log "ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ backend..."
    docker run -d --name wild-backend -p 8000:8000 \
      -v $(pwd)/web-dashboard/backend:/app \
      wild-backend
    
    log "â³ ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° backend (20 ÑĞµĞº)..."
    sleep 20
    
    log "ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° backend..."
    docker ps --filter name=wild-backend --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
    
    log "ğŸ“‹ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ»Ğ¾Ğ³Ğ¾Ğ² backend..."
    docker logs wild-backend --tail 15
    
    log "ğŸ” Ğ¢ĞµÑÑ‚ health endpoint..."
    curl -s http://93.127.214.183:8000/health | jq . 2>/dev/null || curl -s http://93.127.214.183:8000/health
    
    log "ğŸ” Ğ¢ĞµÑÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸..."
    curl -s -X POST http://93.127.214.183:8000/auth/login \
      -H "Content-Type: application/json" \
      -d '{"email":"test@example.com","password":"password123"}' \
      | jq . 2>/dev/null || echo "ĞÑ‚Ğ²ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½"
    
    log "âœ… BACKEND Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•Ğ Ğ˜ ĞŸĞ•Ğ Ğ•Ğ—ĞĞŸĞ£Ğ©Ğ•Ğ!"
    log "ğŸŒ Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ½Ğ° http://93.127.214.183:3000"
    log "ğŸ“§ Email: test@example.com"
    log "ğŸ”‘ Password: password123"
    
else
    log "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿ĞµÑ€ĞµÑĞ±Ğ¾Ñ€ĞºĞ¸ backend"
    docker logs wild-backend 2>/dev/null || echo "ĞĞµÑ‚ Ğ»Ğ¾Ğ³Ğ¾Ğ² backend"
fi

log "ğŸ“Š Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ™ Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡..."
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" 