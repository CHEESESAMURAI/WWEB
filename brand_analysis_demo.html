<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ–º–æ –∞–Ω–∞–ª–∏–∑–∞ –±—Ä–µ–Ω–¥–∞</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            color: #1f2937;
            margin-bottom: 10px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #374151;
        }
        
        .control-group input,
        .control-group select {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .kpi-card {
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .kpi-card.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .kpi-card.orange {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .kpi-card.red {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .kpi-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .section {
            margin: 30px 0;
            padding: 25px;
            background: #f9fafb;
            border-radius: 15px;
            border: 2px solid #e5e7eb;
        }
        
        .section h3 {
            margin: 0 0 20px 0;
            color: #1f2937;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .top-products {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .product-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e5e7eb;
            position: relative;
        }
        
        .product-rank {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .product-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85rem;
            margin-top: 10px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e5e7eb;
        }
        
        .chart-title {
            text-align: center;
            font-size: 1.2rem;
            color: #1f2937;
            margin-bottom: 20px;
        }
        
        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .success {
            background: #d1fae5;
            color: #065f46;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .demo-badge {
            background: #fbbf24;
            color: #92400e;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ –ê–Ω–∞–ª–∏–∑ –±—Ä–µ–Ω–¥–∞ - –î–µ–º–æ —Å–∏—Å—Ç–µ–º–∞</h1>
            <p style="color: #6b7280; font-size: 1.1rem;">
                –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MPStats API –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –±—Ä–µ–Ω–¥–∞
            </p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞</label>
                <input type="text" id="brandName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Mango, Zara, H&M" value="Mango">
            </div>
            
            <div class="control-group">
                <label>–ü–µ—Ä–∏–æ–¥</label>
                <select id="period">
                    <option value="7">7 –¥–Ω–µ–π</option>
                    <option value="14">14 –¥–Ω–µ–π</option>
                    <option value="30" selected>30 –¥–Ω–µ–π</option>
                    <option value="90">90 –¥–Ω–µ–π</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>FBS</label>
                <select id="fbs">
                    <option value="0">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
                    <option value="1">–¢–æ–ª—å–∫–æ FBS</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>–ù–æ–≤–∏–Ω–∫–∏</label>
                <select id="newsmode">
                    <option value="0">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
                    <option value="7">–ó–∞ 7 –¥–Ω–µ–π</option>
                    <option value="14">–ó–∞ 14 –¥–Ω–µ–π</option>
                    <option value="30" selected>–ó–∞ 30 –¥–Ω–µ–π</option>
                </select>
            </div>
            
            <button class="btn" onclick="analyzeBrand()" id="analyzeBtn">
                üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±—Ä–µ–Ω–¥
            </button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        let currentData = null;

        function getDateRange(days) {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - days);
            
            return {
                date_from: startDate.toISOString().split('T')[0],
                date_to: endDate.toISOString().split('T')[0]
            };
        }

        async function analyzeBrand() {
            const brandName = document.getElementById('brandName').value.trim();
            const period = parseInt(document.getElementById('period').value);
            const fbs = parseInt(document.getElementById('fbs').value);
            const newsmode = parseInt(document.getElementById('newsmode').value);
            const resultsDiv = document.getElementById('results');
            const btn = document.getElementById('analyzeBtn');
            
            if (!brandName) {
                resultsDiv.innerHTML = '<div class="error">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞</div>';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'üîÑ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º...';
            resultsDiv.innerHTML = '<div class="loading">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±—Ä–µ–Ω–¥–∞...</div>';
            
            try {
                const dateRange = getDateRange(period);
                
                const response = await fetch('http://localhost:8000/brand/brand-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        brand_name: brandName,
                        date_from: dateRange.date_from,
                        date_to: dateRange.date_to,
                        fbs: fbs,
                        newsmode: newsmode
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                currentData = data;
                displayResults(data);
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±—Ä–µ–Ω–¥';
            }
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
            const hasData = data.brand_info.total_products > 0;
            const demoNotice = !hasData ? '<div class="demo-badge">üé≠ –î–µ–º–æ-—Ä–µ–∂–∏–º: MPStats API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>' : '';
            
            resultsDiv.innerHTML = `
                ${demoNotice}
                
                <!-- KPI –±–ª–æ–∫ -->
                <div class="section">
                    <h3>üè¢ ${data.brand_info.name} - –û–±—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-value">${formatNumber(data.brand_info.total_products)}</div>
                            <div class="kpi-label">–¢–æ–≤–∞—Ä–æ–≤ –≤ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–µ</div>
                        </div>
                        <div class="kpi-card green">
                            <div class="kpi-value">${formatPrice(data.brand_info.total_revenue).replace('‚ÇΩ', '')}</div>
                            <div class="kpi-label">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ (‚ÇΩ)</div>
                        </div>
                        <div class="kpi-card orange">
                            <div class="kpi-value">${formatNumber(data.brand_info.total_sales)}</div>
                            <div class="kpi-label">–û–±—â–∏–µ –ø—Ä–æ–¥–∞–∂–∏ (—à—Ç.)</div>
                        </div>
                        <div class="kpi-card red">
                            <div class="kpi-value">${formatPrice(data.brand_info.average_price).replace('‚ÇΩ', '')}</div>
                            <div class="kpi-label">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ (‚ÇΩ)</div>
                        </div>
                    </div>
                </div>
                
                <!-- –¢–æ–ø —Ç–æ–≤–∞—Ä—ã -->
                ${data.top_products.length > 0 ? `
                <div class="section">
                    <h3>üèÜ –¢–æ–ø-${data.top_products.length} —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤—ã—Ä—É—á–∫–µ</h3>
                    <div class="top-products">
                        ${data.top_products.map((product, index) => `
                            <div class="product-card">
                                <div class="product-rank">#${index + 1}</div>
                                <h4 style="margin: 0 0 10px 0; font-size: 1rem; line-height: 1.3;">
                                    ${product.name}
                                </h4>
                                <div style="color: #6b7280; font-size: 0.9rem; margin-bottom: 10px;">
                                    ${product.category}
                                </div>
                                <div class="product-info">
                                    <div><strong style="color: #10b981;">${formatPrice(product.final_price)}</strong></div>
                                    <div>‚≠ê ${product.rating}/5</div>
                                    <div>üì¶ ${formatNumber(product.sales)} —à—Ç.</div>
                                    <div>üí∞ ${formatPrice(product.revenue)}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
                ${hasData && data.aggregated_charts.sales_graph && data.aggregated_charts.sales_graph.dates ? `
                <div class="section">
                    <h3>üìä –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏</h3>
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-title">üìà –î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–¥–∞–∂</div>
                            <canvas id="salesChart" width="400" height="200"></canvas>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">üì¶ –î–∏–Ω–∞–º–∏–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤</div>
                            <canvas id="stocksChart" width="400" height="200"></canvas>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">üí∞ –î–∏–Ω–∞–º–∏–∫–∞ —Å—Ä–µ–¥–Ω–∏—Ö —Ü–µ–Ω</div>
                            <canvas id="priceChart" width="400" height="200"></canvas>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">üëÅÔ∏è –í–∏–¥–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤</div>
                            <canvas id="visibilityChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
                <div class="section">
                    <h3>üìã –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏</h3>
                    <div class="kpi-grid">
                        <div class="kpi-card" style="background: #f9fafb; color: #1f2937; border: 2px solid #e5e7eb;">
                            <div class="kpi-value" style="color: #1f2937;">${data.brand_metrics.products_with_sales_percentage}%</div>
                            <div class="kpi-label" style="color: #6b7280;">–¢–æ–≤–∞—Ä–æ–≤ —Å –ø—Ä–æ–¥–∞–∂–∞–º–∏</div>
                        </div>
                        <div class="kpi-card" style="background: #f9fafb; color: #1f2937; border: 2px solid #e5e7eb;">
                            <div class="kpi-value" style="color: #1f2937;">${formatNumber(data.brand_metrics.total_comments)}</div>
                            <div class="kpi-label" style="color: #6b7280;">–í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤</div>
                        </div>
                        <div class="kpi-card" style="background: #f9fafb; color: #1f2937; border: 2px solid #e5e7eb;">
                            <div class="kpi-value" style="color: #1f2937;">${data.brand_metrics.average_rating.toFixed(1)}/5</div>
                            <div class="kpi-label" style="color: #6b7280;">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥</div>
                        </div>
                        <div class="kpi-card" style="background: #f9fafb; color: #1f2937; border: 2px solid #e5e7eb;">
                            <div class="kpi-value" style="color: #1f2937;">${data.brand_metrics.fbs_percentage}%</div>
                            <div class="kpi-label" style="color: #6b7280;">–¢–æ–≤–∞—Ä–æ–≤ FBS</div>
                        </div>
                    </div>
                </div>
                
                <!-- –ò—Ç–æ–≥–∏ -->
                <div class="success">
                    <strong>‚úÖ –ê–Ω–∞–ª–∏–∑ –±—Ä–µ–Ω–¥–∞ ${data.brand_info.name} –∑–∞–≤–µ—Ä—à–µ–Ω!</strong><br>
                    –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${data.brand_info.total_products} —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥ ${data.brand_info.date_range}
                </div>
            `;
            
            // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
            if (hasData && data.aggregated_charts.sales_graph && data.aggregated_charts.sales_graph.dates) {
                setTimeout(() => {
                    createCharts(data.aggregated_charts);
                }, 100);
            }
        }

        function createCharts(chartsData) {
            // –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–¥–∞–∂
            if (document.getElementById('salesChart')) {
                new Chart(document.getElementById('salesChart'), {
                    type: 'line',
                    data: {
                        labels: chartsData.sales_graph.dates.map(date => 
                            new Date(date).toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' })
                        ),
                        datasets: [{
                            label: '–ü—Ä–æ–¥–∞–∂–∏ (—à—Ç.)',
                            data: chartsData.sales_graph.values,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }

            // –ì—Ä–∞—Ñ–∏–∫ –æ—Å—Ç–∞—Ç–∫–æ–≤
            if (document.getElementById('stocksChart')) {
                new Chart(document.getElementById('stocksChart'), {
                    type: 'line',
                    data: {
                        labels: chartsData.stocks_graph.dates.map(date => 
                            new Date(date).toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' })
                        ),
                        datasets: [{
                            label: '–û—Å—Ç–∞—Ç–∫–∏ (—à—Ç.)',
                            data: chartsData.stocks_graph.values,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }

            // –ì—Ä–∞—Ñ–∏–∫ —Ü–µ–Ω
            if (document.getElementById('priceChart')) {
                new Chart(document.getElementById('priceChart'), {
                    type: 'line',
                    data: {
                        labels: chartsData.price_graph.dates.map(date => 
                            new Date(date).toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' })
                        ),
                        datasets: [{
                            label: '–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ (‚ÇΩ)',
                            data: chartsData.price_graph.values,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: false } }
                    }
                });
            }

            // –ì—Ä–∞—Ñ–∏–∫ –≤–∏–¥–∏–º–æ—Å—Ç–∏
            if (document.getElementById('visibilityChart')) {
                new Chart(document.getElementById('visibilityChart'), {
                    type: 'line',
                    data: {
                        labels: chartsData.visibility_graph.dates.map(date => 
                            new Date(date).toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' })
                        ),
                        datasets: [{
                            label: '–í–∏–¥–∏–º–æ—Å—Ç—å',
                            data: chartsData.visibility_graph.values,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                maximumFractionDigits: 0
            }).format(price);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('ru-RU').format(num);
        }

        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –¥–µ–º–æ
        window.addEventListener('load', function() {
            console.log('üöÄ –î–µ–º–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–Ω–∞–ª–∏–∑–∞ –±—Ä–µ–Ω–¥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            console.log('üí° –ù–∞–∂–º–∏—Ç–µ "–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±—Ä–µ–Ω–¥" –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
        });
    </script>
</body>
</html> 